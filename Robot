from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup, InputFile
from telegram.ext import ApplicationBuilder, CommandHandler, MessageHandler, CallbackQueryHandler, ConversationHandler, ContextTypes, filters
import os
import traceback
import asyncio
import nest_asyncio

nest_asyncio.apply()  # Ø­Ù„ Ù…Ø´Ú©Ù„ Event Loop Ø¯Ø± Pydroid

TOKEN = "8204495128:AAGdk27EYC0K9Wy5TNdK9YahBwgTxHOnK2s"

SAVE_FOLDER = "user_files"
os.makedirs(SAVE_FOLDER, exist_ok=True)

LANG, RECEIVE_CODE, BROADCAST = range(3)
user_codes = {}
all_users = set()  # Ø°Ø®ÛŒØ±Ù‡ Ø¢ÛŒØ¯ÛŒ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†
ADMIN_ID = 7503028992

# Ø´Ø±ÙˆØ¹ Ø±Ø¨Ø§Øª
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.message.from_user.id
    all_users.add(user_id)
    
    keyboard = [
        [InlineKeyboardButton("ğŸ‡®ğŸ‡· ÙØ§Ø±Ø³ÛŒ", callback_data='fa')],
        [InlineKeyboardButton("ğŸ‡¬ğŸ‡§ English", callback_data='en')]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    await update.message.reply_text(
        "Ù„Ø·ÙØ§ Ø²Ø¨Ø§Ù† Ø®ÙˆØ¯ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯ / Please choose your language:",
        reply_markup=reply_markup
    )
    return LANG

# Ø§Ù†ØªØ®Ø§Ø¨ Ø²Ø¨Ø§Ù†
async def language_choice(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    context.user_data['lang'] = query.data
    
    # Ú©ÛŒØ¨ÙˆØ±Ø¯ Ø§ØµÙ„ÛŒ Ø¨Ø§ Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯
    keyboard = [
        [InlineKeyboardButton("Ø«Ø¨Øª ØªØ¨Ù„ÛŒØº", url="https://t.me/amirlphastam")],
        [InlineKeyboardButton("Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù…", callback_data="broadcast") if query.from_user.id == ADMIN_ID else None]
    ]
    keyboard = [row for row in keyboard if row is not None]  # Ø­Ø°Ù None
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    text = "Ù„Ø·ÙØ§ Ú©Ø¯ Ù¾Ø§ÛŒØªÙˆÙ† Ø®ÙˆØ¯ Ø±Ø§ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯:" if query.data=='fa' else "Please send your Python code:"
    await query.edit_message_text(text, reply_markup=reply_markup)
    return RECEIVE_CODE

# Ø¯Ø±ÛŒØ§ÙØª Ú©Ø¯ Ú©Ø§Ø±Ø¨Ø±
async def receive_code(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.message.from_user.id
    all_users.add(user_id)
    code = update.message.text
    user_codes[user_id] = code

    filepath = os.path.join(SAVE_FOLDER, f"{user_id}.py")
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(code)  # Ø§ÛŒÙ†Ø¬Ø§ Ú©Ø¯ Ù¾Ø§ÛŒØªÙˆÙ† ÙˆØ§Ù‚Ø¹ÛŒ Ø¯Ø§Ø®Ù„ ÙØ§ÛŒÙ„ Ø°Ø®ÛŒØ±Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯

    keyboard = [
        [InlineKeyboardButton("Ø¯Ø±ÛŒØ§ÙØª Ú©Ø¯ Ø¬Ø¯ÛŒØ¯", callback_data='update')],
        [InlineKeyboardButton("Ø¯Ø±ÛŒØ§ÙØª Ú©Ø¯ Ù‚Ø¯ÛŒÙ…", callback_data='old')]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)

    text = "âœ… Ú©Ø¯ Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯" if context.user_data.get('lang')=='fa' else "âœ… Code received"
    await update.message.reply_text(text, reply_markup=reply_markup)
    return RECEIVE_CODE

# Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ø´ÛŒØ´Ù‡â€ŒØ§ÛŒ
async def button(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    user_id = query.from_user.id
    lang = context.user_data.get('lang', 'fa')

    if query.data == 'old':
        filepath = os.path.join(SAVE_FOLDER, f"{user_id}.py")
        if os.path.exists(filepath):
            await query.message.reply_document(document=InputFile(filepath), filename=f"{user_id}.py")
        else:
            text = "ÙØ§ÛŒÙ„ Ù‚Ø¯ÛŒÙ… Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛŒØ³Øª âŒ" if lang=='fa' else "Old file not found âŒ"
            await query.message.reply_text(text)

    elif query.data == 'update':
        code = user_codes.get(user_id, "")
        error = None
        try:
            exec(code, {})  # Ø¨Ø±Ø±Ø³ÛŒ Ø®Ø·Ø§
        except Exception as e:
            error = e

        filepath = os.path.join(SAVE_FOLDER, f"{user_id}.py")
        with open(filepath, "w", encoding="utf-8") as f:
            f.write(code)

        if error:
            text = f"âŒ Ø®Ø·Ø§ Ø¯Ø± Ú©Ø¯ Ø´Ù…Ø§\n{traceback.format_exc()}" if lang=='fa' else f"âŒ Error in your code\n{traceback.format_exc()}"
        else:
            text = "âœ… Ø®Ø·Ø§ÛŒÛŒ Ù†Ø¯Ø§Ø±Ø¯\nÙØ§ÛŒÙ„ Ù¾Ø§ÛŒØªÙˆÙ† Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø³Øª" if lang=='fa' else "âœ… No errors\nPython file is ready"
            await query.message.reply_document(document=InputFile(filepath), filename=f"{user_id}.py")

        keyboard = [
            [InlineKeyboardButton("Ø¯Ø±ÛŒØ§ÙØª Ú©Ø¯ Ø¬Ø¯ÛŒØ¯", callback_data='update')],
            [InlineKeyboardButton("Ø¯Ø±ÛŒØ§ÙØª Ú©Ø¯ Ù‚Ø¯ÛŒÙ…", callback_data='old')]
        ]
        reply_markup = InlineKeyboardMarkup(keyboard)
        await query.message.reply_text(text, reply_markup=reply_markup)

    elif query.data == 'broadcast':
        if user_id == ADMIN_ID:
            await query.message.reply_text("Ù¾ÛŒØ§Ù… Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯ / Enter your message:")
            return BROADCAST

async def broadcast_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.message.from_user.id
    if user_id != ADMIN_ID:
        return RECEIVE_CODE

    text = update.message.text
    for uid in all_users:
        try:
            await context.bot.send_message(uid, f"ğŸ“¢ Ù¾ÛŒØ§Ù… Ø§Ø¯Ù…ÛŒÙ†:\n{text}")
        except:
            pass

    await update.message.reply_text("Ù¾ÛŒØ§Ù… Ø¨Ø±Ø§ÛŒ ØªÙ…Ø§Ù… Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯ âœ…")
    return RECEIVE_CODE

async def cancel(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text("ğŸ”´ Ù…Ú©Ø§Ù„Ù…Ù‡ Ù„ØºÙˆ Ø´Ø¯ / Conversation canceled")
    return ConversationHandler.END

async def main():
    app = ApplicationBuilder().token(TOKEN).build()

    conv_handler = ConversationHandler(
        entry_points=[CommandHandler('start', start)],
        states={
            LANG: [CallbackQueryHandler(language_choice)],
            RECEIVE_CODE: [
                MessageHandler(filters.TEXT & ~filters.COMMAND, receive_code),
                CallbackQueryHandler(button)
            ],
            BROADCAST: [MessageHandler(filters.TEXT & ~filters.COMMAND, broadcast_message)]
        },
        fallbacks=[CommandHandler('cancel', cancel)],
        allow_reentry=True
    )

    app.add_handler(conv_handler)
    print("Ø±Ø¨Ø§Øª ÙØ¹Ø§Ù„ Ø´Ø¯ âœ…")
    await app.run_polling()

if __name__ == "__main__":
    asyncio.get_event_loop().run_until_complete(main())
                
